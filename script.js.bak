function initMobileNav() {
  const hamburger = document.getElementById('hamburger');
  const navLinks = document.getElementById('navLinks');
  if (!hamburger || !navLinks) return;

  hamburger.addEventListener('click', () => {
    navLinks.classList.toggle('show');
  });
}

function initSmoothScroll() {
  const navLinks = document.getElementById('navLinks');
  document.querySelectorAll('a[href^="#"]').forEach(a => {
    a.addEventListener('click', function (e) {
      const target = document.querySelector(this.getAttribute('href'));
      if (target) {
        e.preventDefault();
        const offset = document.getElementById('navbar')?.offsetHeight || 70;
        const top = target.getBoundingClientRect().top + window.pageYOffset - offset;
        window.scrollTo({ top, behavior: 'smooth' });
        if (navLinks && navLinks.classList.contains('show')) {
          navLinks.classList.remove('show');
        }
      }
    });
  });
}

function initFadeUpAnimations() {
  const io = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) entry.target.classList.add('in-view');
    });
  }, { threshold: 0.12 });

  const elements = document.querySelectorAll('.fade-up');
  elements.forEach(el => io.observe(el));
}

function initTestimonialsSlider() {
  const slides = document.querySelectorAll('.test-slider .test');
  if (slides.length === 0) return;

  let si = 0;
  setInterval(() => {
    slides[si].classList.remove('active');
    si = (si + 1) % slides.length;
    slides[si].classList.add('active');
  }, 4200);
}

function initEnrollModal() {
  const enrollButtons = document.querySelectorAll('[data-enroll]');
  const modal = document.getElementById('enrollModal');
  if (!modal || enrollButtons.length === 0) return;

  const modalClose = document.getElementById('modalClose');
  const modalTitle = document.getElementById('modalTitle');
  const modalDesc = document.getElementById('modalDesc');
  const enrollForm = document.getElementById('enrollForm');

  const programDetails = {
    'prep-year': { title: 'Preparatory Year for Studying in Spain', desc: 'Comprehensive year-long program preparing students linguistically and academically for Spanish universities.' },
    'prep-in-spain': { title: 'Preparatory Programs inside Spain', desc: 'Short immersive stays in partner schools across Spain to accelerate language acquisition.' },
    'comm-tourism': { title: 'Communication & Linguistic Tourism', desc: 'Practical communication-focused lessons combined with guided cultural visits.' },
    'camps': { title: 'Language Camps in Spain', desc: '1–4 week camps with lessons, activities and homestays to maximise immersion.' },
    'exams': { title: 'DELE / SIELE / CCSE Preparation', desc: 'Intensive exam training with mock tests, feedback and strategy sessions.' },
  };

  const focusableElementsString = 'a[href], button:not([disabled]), textarea, input, select';
  let firstFocusableEl, lastFocusableEl;

  function openModal(key) {
    const info = programDetails[key] || { title: 'Enrollment', desc: 'Please select a program from the list.' };
    if (modalTitle) modalTitle.textContent = info.title;
    if (modalDesc) modalDesc.textContent = info.desc;
    modal.setAttribute('aria-hidden', 'false');
    document.body.style.overflow = 'hidden';

    const focusableElements = modal.querySelectorAll(focusableElementsString);
    firstFocusableEl = focusableElements[0];
    lastFocusableEl = focusableElements[focusableElements.length - 1];
    firstFocusableEl?.focus();
  }

  function closeModal() {
    modal.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';
  }

  function trapFocus(e) {
    if (e.key !== 'Tab') return;
    if (e.shiftKey) {
      if (document.activeElement === firstFocusableEl) {
        lastFocusableEl.focus();
        e.preventDefault();
      }
    } else {
      if (document.activeElement === lastFocusableEl) {
        firstFocusableEl.focus();
        e.preventDefault();
      }
    }
  }

  enrollButtons.forEach(btn => {
    btn.addEventListener('click', (e) => {
      const key = e.currentTarget.dataset.enroll;
      openModal(key);
    });
  });

  if (modalClose) modalClose.addEventListener('click', closeModal);
  modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

  if (enrollForm) {
    enrollForm.addEventListener('submit', function (ev) {
      ev.preventDefault();
      alert('Thank you! Your enrollment request has been submitted. We will contact you soon.');
      closeModal();
      this.reset();
    });
  }

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modal.getAttribute('aria-hidden') === 'false') closeModal();
    if (modal.getAttribute('aria-hidden') === 'false') trapFocus(e);
  });
}

function initContactForm() {
  const contactForm = document.getElementById('contactForm');
  const formMsg = document.getElementById('formMsg');
  if (!contactForm || !formMsg) return;

  contactForm.addEventListener('submit', function (ev) {
    ev.preventDefault();
    formMsg.textContent = 'Sending...';
    setTimeout(() => {
      formMsg.textContent = 'Thank you! We received your message — we will reply within 48 hours.';
      contactForm.reset();
    }, 900);
  });
}

function initHeroAnimation() {
  const hero = document.querySelector('.hero');
  if (!hero) return;

  window.addEventListener('scroll', () => {
    const sc = window.scrollY;
    hero.style.backgroundPosition = `center ${Math.max(-20, -sc * 0.15)}px`;
  }, { passive: true });
}

document.addEventListener('DOMContentLoaded', () => {
  initMobileNav();
  initSmoothScroll();
  initFadeUpAnimations();
  initTestimonialsSlider();
  initEnrollModal();
  initContactForm();
  initHeroAnimation();
});